{% extends "base.html" %}
{% block content %}
<div class="min-h-screen bg-gradient-to-br from-purple-50 via-white to-pink-50 dark:from-slate-900 dark:via-slate-950 dark:to-indigo-950">
  <main class="container mx-auto px-6 pt-16 pb-10">
    <div>
      <a href="/" class="inline-flex items-center text-sm text-gray-600 dark:text-slate-300 hover:text-gray-900 dark:hover:text-white mb-3 transition-colors">
        <svg class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none">
          <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Back to Dashboard
      </a>

      {% set member_count = members|length %}
      <div class="space-y-4">
        <div class="flex flex-col gap-4 rounded-2xl border border-gray-200 dark:border-slate-800 bg-white/80 dark:bg-slate-950/60 p-4">
          <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                <span class="text-xl font-bold text-white">{{ group.name[0] }}</span>
              </div>
              <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">{{ group.name }}</h1>
                <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-slate-300">
                  <span class="font-mono bg-gray-100 dark:bg-slate-800 px-2 py-0.5 rounded">
                    {{ group.join_code }}
                  </span>
                  <button class="p-1 rounded-full bg-purple-600 hover:bg-purple-700 text-white transition-colors flex items-center" data-copy-btn data-copy-value="{{ group.join_code }}">
                    <svg class="w-4 h-4 copy-icon" viewBox="0 0 24 24" fill="none">
                      <rect x="9" y="9" width="13" height="13" rx="2" stroke="currentColor" stroke-width="2"/>
                      <rect x="3" y="3" width="13" height="13" rx="2" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <svg class="w-4 h-4 hidden check-icon text-white" viewBox="0 0 24 24" fill="none">
                      <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
            <div class="ml-auto flex flex-wrap gap-3">
              <button data-dialog-open="addTimeDialog" class="gap-2 px-4 py-2 rounded-full bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold inline-flex items-center">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                  <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Add Time Range
              </button>
              <button data-dialog-open="proposalDialog" class="gap-2 px-4 py-2 rounded-full bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold inline-flex items-center">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                  <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M22 2L15 22l-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Propose Meetup
              </button>
              <button type="button" class="gap-2 px-4 py-2 rounded-full border border-purple-200 dark:border-purple-500/30 text-purple-700 dark:text-purple-200 text-sm font-semibold inline-flex items-center hover:bg-purple-50 dark:hover:bg-purple-500/10 transition-colors" onclick="openExportDialog({{ group.id }})">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                  <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M8 9l4 4 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M5 21h14a2 2 0 002-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M3 15v4a2 2 0 002 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Export to Google
              </button>
              <button type="button" class="gap-2 px-4 py-2 rounded-full border border-purple-200 dark:border-purple-500/30 text-purple-700 dark:text-purple-200 text-sm font-semibold inline-flex items-center hover:bg-purple-50 dark:hover:bg-purple-500/10 transition-colors" data-dialog-open="groupSettingsDialog">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                  <path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z" stroke="currentColor" stroke-width="2"/>
                  <path d="M19.4 15a1.7 1.7 0 0 0 .34 1.87l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.7 1.7 0 0 0-1.87-.34 1.7 1.7 0 0 0-1 1.55V22a2 2 0 1 1-4 0v-.1a1.7 1.7 0 0 0-1-1.55 1.7 1.7 0 0 0-1.87.34l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.7 1.7 0 0 0 5 15.4a1.7 1.7 0 0 0-1.55-1H3a2 2 0 1 1 0-4h.1A1.7 1.7 0 0 0 4.65 9a1.7 1.7 0 0 0-.34-1.87l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.7 1.7 0 0 0 9 4.65 1.7 1.7 0 0 0 10.55 3H11a2 2 0 1 1 4 0v.1a1.7 1.7 0 0 0 1 1.55 1.7 1.7 0 0 0 1.87-.34l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.7 1.7 0 0 0 20 9.4c0 .67.4 1.27 1 1.55H22a2 2 0 1 1 0 4h-.1a1.7 1.7 0 0 0-1.55 1z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Group Settings
              </button>
            </div>
          </div>
          <div class="grid gap-3 sm:grid-cols-3">
            <div class="rounded-xl border border-gray-200 dark:border-slate-800 bg-white dark:bg-slate-950 px-3 py-2.5">
              <p class="text-xs uppercase text-gray-500 dark:text-slate-400">Members</p>
              <p class="text-lg font-semibold text-gray-900 dark:text-white">{{ member_count }}</p>
            </div>
            <div class="rounded-xl border border-gray-200 dark:border-slate-800 bg-white dark:bg-slate-950 px-3 py-2.5">
              <p class="text-xs uppercase text-gray-500 dark:text-slate-400">Timezone</p>
              <p class="text-sm font-semibold text-gray-900 dark:text-white">{{ display_timezone }}</p>
            </div>
            <div class="rounded-xl border border-gray-200 dark:border-slate-800 bg-white dark:bg-slate-950 px-3 py-2.5">
              <p class="text-xs uppercase text-gray-500 dark:text-slate-400">Join Code</p>
              <p class="text-sm font-semibold text-gray-900 dark:text-white">{{ group.join_code }}</p>
            </div>
          </div>
        </div>

        <div class="grid gap-4 lg:grid-cols-[1.1fr_0.75fr_1.45fr]">
          <div class="bg-white dark:bg-slate-950 rounded-xl border border-gray-200 dark:border-slate-800 shadow-sm p-5">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2">
                <span class="w-8 h-8 rounded-lg bg-purple-600/10 text-purple-600 dark:text-purple-300 flex items-center justify-center">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none">
                    <path d="M10 13a5 5 0 0 1 7 0l2 2a5 5 0 0 1-7 7l-1-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <path d="M14 11a5 5 0 0 0-7 0L5 13a5 5 0 0 0 7 7l1-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </span>
                <div>
                  <p class="text-sm font-semibold text-gray-900 dark:text-white">Invite Link</p>
                  <p class="text-xs text-gray-500 dark:text-slate-400">Generate a shareable link for teammates.</p>
                </div>
              </div>
            </div>
            <div class="flex items-center gap-2 mb-4">
              <input id="inviteLink" value="" placeholder="Create an invite link" readOnly class="text-xs font-mono bg-gray-50 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-lg px-3 py-2 w-full text-gray-600 dark:text-slate-300"/>
              <button class="px-3 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white" onclick="copyInviteLink({{ group.id }}, this)">
                <svg class="w-4 h-4 copy-icon text-white" viewBox="0 0 24 24" fill="none">
                  <rect x="9" y="9" width="13" height="13" rx="2" stroke="currentColor" stroke-width="2"/>
                  <rect x="3" y="3" width="13" height="13" rx="2" stroke="currentColor" stroke-width="2"/>
                </svg>
                <svg class="w-4 h-4 hidden check-icon text-white" viewBox="0 0 24 24" fill="none">
                  <path d="M5 13l4 4L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-[auto_1fr_auto] gap-3 items-center">
              <label class="text-xs text-gray-500 dark:text-slate-400">Expires in:</label>
              <select id="inviteDays" class="h-9 text-xs bg-white dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-lg px-3 text-gray-700 dark:text-slate-200 w-full">
                <option value="1">1 day</option>
                <option value="3">3 days</option>
                <option value="7" selected>7 days</option>
                <option value="30">30 days</option>
              </select>
              <button class="px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white text-sm font-semibold" onclick="createInvite({{ group.id }})">Create</button>
            </div>
          </div>

          <div class="bg-white dark:bg-slate-950 rounded-xl border border-gray-200 dark:border-slate-800 shadow-sm p-5">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="text-sm font-semibold text-gray-900 dark:text-white">Legend</h3>
                <p class="text-xs text-gray-500 dark:text-slate-400">Availability types</p>
              </div>
              <span class="text-[10px] uppercase tracking-wide px-2 py-1 rounded-full bg-purple-100 dark:bg-purple-500/20 text-purple-700 dark:text-purple-200 font-semibold">Live</span>
            </div>
            <div class="grid gap-3 text-sm">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="w-3.5 h-3.5 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 shadow-[0_0_10px_rgba(168,85,247,0.45)]"></span>
                  <span class="text-gray-700 dark:text-slate-200">Available</span>
                </div>
                <span class="text-xs text-gray-500 dark:text-slate-400">Open</span>
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="w-3.5 h-3.5 rounded-full bg-gradient-to-br from-red-400 to-red-600 shadow-[0_0_10px_rgba(248,113,113,0.45)]"></span>
                  <span class="text-gray-700 dark:text-slate-200">Blocked</span>
                </div>
                <span class="text-xs text-gray-500 dark:text-slate-400">Unavailable</span>
              </div>
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="w-3.5 h-3.5 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 shadow-[0_0_10px_rgba(251,146,60,0.45)]"></span>
                  <span class="text-gray-700 dark:text-slate-200">Proposed</span>
                </div>
                <span class="text-xs text-gray-500 dark:text-slate-400">Pending</span>
              </div>
            </div>
          </div>

          <div class="bg-white dark:bg-slate-950 rounded-xl border border-gray-200 dark:border-slate-800 shadow-sm p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-semibold text-gray-900 dark:text-white">Members</h3>
              <span class="text-xs text-gray-500 dark:text-slate-400">{{ member_count }} total</span>
            </div>
            <div class="space-y-3">
              {% if members %}
                {% for u, m in members %}
                  <div class="flex items-center gap-3">
                    {% if u.profile_pic_url %}
                      <img src="{{ u.profile_pic_url }}" alt="Profile" class="w-8 h-8 rounded-full object-cover border border-purple-200 dark:border-purple-400/40"/>
                    {% else %}
                      <div class="w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-500/20 flex items-center justify-center text-purple-600 dark:text-purple-300 text-xs font-semibold">
                        {{ (u.display_name or u.name or "U")[0] }}
                      </div>
                    {% endif %}
                    <div class="flex-1">
                      <div class="flex flex-wrap items-center gap-2">
                        <p class="text-sm font-medium text-gray-900 dark:text-white">{{ u.display_name or u.name }}</p>
                        {% if m.role == "admin" %}
                          <span class="text-[10px] uppercase tracking-wide px-2 py-0.5 rounded-full bg-purple-100 dark:bg-purple-500/20 text-purple-700 dark:text-purple-200 font-semibold">Admin</span>
                        {% endif %}
                        {% if current_user.is_authenticated and u.id == current_user.id %}
                          <span class="text-[10px] uppercase tracking-wide px-2 py-0.5 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-200 font-semibold">You</span>
                        {% endif %}
                      </div>
                      <p class="text-xs text-gray-500 dark:text-slate-400">{{ u.email }}</p>
                    </div>
                    {% if is_admin and u.id != current_user.id and m.role != "admin" %}
                      <button type="button" class="member-pill-btn" onclick="promoteMember({{ group.id }}, {{ u.id }})">Make admin</button>
                    {% endif %}
                    <span class="w-3 h-3 rounded-full" style="background: {{ m.color_hex }};"></span>
                  </div>
                {% endfor %}
              {% else %}
                <p class="text-sm text-gray-500 dark:text-slate-400">Invite teammates to see them here.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="bg-white dark:bg-slate-950 rounded-xl border border-gray-200 dark:border-slate-800 shadow-sm p-4 sm:p-6">
          <div class="mb-4 flex flex-wrap items-center justify-between gap-3">
            <div>
              <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Shared Calendar</h2>
              <p class="text-sm text-gray-500 dark:text-slate-400">View availability across your group.</p>
            </div>
          </div>
          <div class="calendar-scroll">
            <div class="min-w-0">
              <div id="calendar" data-group-id="{{ group.id }}" data-demo="{{ '1' if demo_mode else '' }}" data-timezone="{{ current_user.timezone or '' }}"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<dialog id="addTimeDialog" class="dialog">
  <div class="dialog-card">
    <div class="dialog-header">
      <h3>Add Time Range</h3>
      <p>Add when you're available or block off times you're busy.</p>
    </div>
    <div class="dialog-body">
      <div class="segmented-toggle">
        <button type="button" class="segmented-btn is-available" data-time-type="available" onclick="setTimeType('available')">Available</button>
        <button type="button" class="segmented-btn is-blocked" data-time-type="blocked" onclick="setTimeType('blocked')">Blocked</button>
      </div>
      <div class="grid sm:grid-cols-2 gap-3">
        <div class="sm:col-span-2">
          <label class="dialog-label" for="timeDate">Date</label>
          <input id="timeDate" type="date" class="dialog-input w-full"/>
        </div>
        <div>
          <label class="dialog-label" for="timeStart">Start Time</label>
          <input id="timeStart" type="time" class="dialog-input w-full"/>
        </div>
        <div>
          <label class="dialog-label" for="timeEnd">End Time</label>
          <input id="timeEnd" type="time" class="dialog-input w-full"/>
        </div>
      </div>
      <button type="button" class="dialog-btn primary" onclick="submitAddTime({{ group.id }})">Add Time Range</button>
      <button type="button" class="dialog-btn ghost" data-dialog-close>Cancel</button>
    </div>
  </div>
</dialog>

<dialog id="proposalDialog" class="dialog">
  <div class="dialog-card">
    <div class="dialog-header">
      <h3>Propose a Meetup</h3>
      <p>Suggest a meeting time to your group.</p>
    </div>
    <div class="dialog-body">
      <div class="grid sm:grid-cols-2 gap-3">
        <div class="sm:col-span-2">
          <label class="dialog-label" for="proposalDate">Date</label>
          <input id="proposalDate" type="date" class="dialog-input w-full"/>
        </div>
        <div>
          <label class="dialog-label" for="proposalStart">Start Time</label>
          <input id="proposalStart" type="time" class="dialog-input w-full"/>
        </div>
        <div>
          <label class="dialog-label" for="proposalEnd">End Time</label>
          <input id="proposalEnd" type="time" class="dialog-input w-full"/>
        </div>
      </div>
      <label class="dialog-label" for="meetLoc">Location</label>
      <input id="meetLoc" class="dialog-input" placeholder="e.g., Conference Room A, Zoom link"/>
      <label class="dialog-label" for="meetDesc">Description</label>
      <textarea id="meetDesc" class="dialog-input" rows="3" placeholder="What's this meeting about?"></textarea>
      <button type="button" class="dialog-btn primary" onclick="submitProposal({{ group.id }})">Send Proposal</button>
      <button type="button" class="dialog-btn ghost" data-dialog-close>Cancel</button>
    </div>
  </div>
</dialog>

<dialog id="groupSettingsDialog" class="dialog">
  <div class="dialog-card dialog-card-wide">
    <div class="dialog-header">
      <h3>Group Settings</h3>
      <p>Update group details and calendar preferences.</p>
    </div>
    <form method="post" action="/groups/{{ group.id }}/settings" class="dialog-body">
      <label class="dialog-label" for="groupName">Group name</label>
      <input id="groupName" name="name" class="dialog-input" value="{{ group.name }}"/>

      <label class="dialog-label" for="groupTimezone">Timezone</label>
      <select id="groupTimezone" name="timezone" class="dialog-input">
        {% set tz_value = display_timezone or "UTC" %}
        {% for tz in [
          "UTC",
          "GMT-12:00","GMT-11:00","GMT-10:00","GMT-09:00","GMT-08:00","GMT-07:00","GMT-06:00","GMT-05:00",
          "GMT-04:00","GMT-03:00","GMT-02:00","GMT-01:00",
          "GMT+00:00","GMT+01:00","GMT+02:00","GMT+03:00","GMT+04:00","GMT+05:00","GMT+06:00","GMT+07:00",
          "GMT+08:00","GMT+09:00","GMT+10:00","GMT+11:00","GMT+12:00","GMT+13:00","GMT+14:00"
        ] %}
          <option value="{{ tz }}" {% if tz_value == tz %}selected{% endif %}>{{ tz }}</option>
        {% endfor %}
      </select>

      <label class="dialog-label" for="groupJoinCode">Join code</label>
      <div class="flex gap-2">
        <input id="groupJoinCode" name="join_code" class="dialog-input flex-1" value="{{ group.join_code }}" {% if not is_admin %}readonly{% endif %}/>
        <button type="button" class="dialog-btn ghost" onclick="copyText(document.getElementById('groupJoinCode').value)">Copy</button>
        {% if is_admin %}
          <button type="button" class="dialog-btn ghost" onclick="regenerateJoinCode({{ group.id }})">Regenerate</button>
        {% endif %}
      </div>

      <button class="dialog-btn primary" type="submit">Save changes</button>
      <button type="button" class="dialog-btn ghost" data-dialog-close>Close</button>
    </form>
  </div>
</dialog>

<dialog id="exportCalendarDialog" class="dialog">
  <div class="dialog-card dialog-card-wide">
    <div class="dialog-header">
      <h3>Export to Google Calendar</h3>
      <p>Create or update your groupâ€™s synced calendar.</p>
    </div>
    <div class="dialog-body">
      <div id="exportCalendarStatus" class="dialog-hint"></div>

      <label class="dialog-label" for="exportCalendarName">Calendar name</label>
      <input id="exportCalendarName" class="dialog-input" placeholder="Phase - Your group"/>

      <label class="dialog-label" for="exportCalendarTimezone">Timezone</label>
      <select id="exportCalendarTimezone" class="dialog-input">
        {% set tz_value = display_timezone or "UTC" %}
        {% for tz in [
          "UTC",
          "GMT-12:00","GMT-11:00","GMT-10:00","GMT-09:00","GMT-08:00","GMT-07:00","GMT-06:00","GMT-05:00",
          "GMT-04:00","GMT-03:00","GMT-02:00","GMT-01:00",
          "GMT+00:00","GMT+01:00","GMT+02:00","GMT+03:00","GMT+04:00","GMT+05:00","GMT+06:00","GMT+07:00",
          "GMT+08:00","GMT+09:00","GMT+10:00","GMT+11:00","GMT+12:00","GMT+13:00","GMT+14:00"
        ] %}
          <option value="{{ tz }}" {% if tz_value == tz %}selected{% endif %}>{{ tz }}</option>
        {% endfor %}
      </select>

      <div class="export-section">
        <div class="dialog-label">Member colors</div>
        <div id="exportMemberColors" class="export-member-list"></div>
      </div>

      <div class="calendar-select-list">
        <label class="calendar-select-item">
          <input id="exportInviteMembers" type="checkbox" checked/>
          <span class="calendar-select-name">Invite members to the calendar</span>
        </label>
        <label class="calendar-select-item">
          <input id="exportOverwrite" type="checkbox" checked/>
          <span class="calendar-select-name">Replace existing Phase events</span>
        </label>
      </div>

      <div class="export-actions">
        <button id="exportCreateBtn" type="button" class="dialog-btn primary">Create synced calendar</button>
        <button id="exportUpdateBtn" type="button" class="dialog-btn ghost">Update synced calendar</button>
      </div>
      <button type="button" class="dialog-btn ghost" data-dialog-close>Cancel</button>
    </div>
  </div>
</dialog>

<script>
  window.__GROUP_ID__ = {{ group.id }};
</script>
{% endblock %}
